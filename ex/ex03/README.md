(テーマ) ネットワークバイトオーダー 
===================================

実習内容
--------
ネットワークバイトオーダーを実感するプログラムを書く。

方針
----

整数0x12345678を

    union my_num {
        int num;
        unsigned char buf[4];
    };
    my_num x.num = 0x12345678;

とunionを使って定義し、バイトオーダを確認するプログラムを書く。

サンプルコードは ~/daqmw-tc/bs/byte_order にある。
変換は

    #include <apra/inet.h>
    
    int x = 0x12345678;
    int y = htonl(x);
    int z = ntohl(y);

のように行う。

htonl()を使うために必要なインクルードファイルはman htonlするとSYNOPSISの
ところに書いているとおりで、上の例のように

    #include <apra/inet.h>

が必要。

unionは上のように定義したときにx.numとするとintとしてアクセスできる。
これとおなじ内容でunsigned charとしてアクセスするときには
x.buf[0], x.buf[1], x.buf[2], x.buf[3]を使う。

出力例:

    変数名: 変数アドレス: 配列インデックス: 値
    
    x: 0x7fff78597440 0 0x78
    x: 0x7fff78597441 1 0x56
    x: 0x7fff78597442 2 0x34
    x: 0x7fff78597443 3 0x12
    y: 0x7fff78597430 0 0x12
    y: 0x7fff78597431 1 0x34
    y: 0x7fff78597432 2 0x56
    y: 0x7fff78597433 3 0x78

char bufferからの数値の取り出し
-------------------------------

デコードのときに必要になるのでchar buf[1024]のようなバッファからの
数値の取り出し方法についてここでまとめておく。

下のようなバッファからint, shortを取り出すには次のようなコードを
書けばよい。

    /*
     *  0      1      2      3      4      5      6      7
     * +------+------+------+------+------+------+------+------+
     * | 0x01 | 0x23 | 0x45 | 0x67 | 0x89 | 0xab | 0xcd | 0xef |
     * +------+------+------+------+------+------+------+------+
     * <---------------------------><------------><------------>
     *              int                 short         short
     */

    unsigned char  buf[8];  // データが入っているとする
    unsigned int   *int_p;  // int (4バイト整数へのポインタ)
    unsigned short *short_p // short (2バイト整数へのポインタ)
    int   x;
    short y;

    int_p = (unsigned int *)&buf[0]; // buf[0]のアドレスをセット。型が違うのでキャスト(unsigned int *)が必要
    x = *int_p;                      // *を付けると値が取り出せるのでxに代入している
                                     // ネットワークバイトオーダからホストオーダに変更する必要があるなら
                                     // x = ntohl(x); とする。

    // shortも同様
    short_p = (unsigned short *)&buf[4]; // buf[4]のアドレスをセット
    y = *short_p;                    // ネットワークバイトオーダからホストオーダに変更する必要があるなら
                                     // y = ntohs(y); とする。
    
    // buf[6] buf[7]のshortの取り出しも同様

ソースファイルは ~/daqmw-tc/ex/ex3 にあるので ~/sandbox/ ディレクトリにコピーして
試してみる。
